# .github/workflows/release-builder.yml

# Nome do Workflow: Aparecerá no separador "Actions" do seu repositório no GitHub.
name: Build Android Release APK

# Gatilho (Trigger): Define quando este workflow deve ser executado.
on:
  push:
    tags:
      - 'v*.*.*' # Executa sempre que uma tag que começa com 'v' (ex: v1.0.0, v1.2.3) é enviada para o repositório.

env:
  flutter-channel: 'stable'
  flutter-version: '3.38.6'

# Trabalhos (Jobs): Define uma sequência de tarefas a serem executadas.
jobs:
  build-android:
    # Nome do trabalho: Aparecerá na interface do GitHub Actions.
    name: Build Flutter App for Android

    # Máquina Virtual: Especifica o tipo de máquina que o GitHub deve usar para executar o trabalho.
    # 'ubuntu-latest' é a escolha padrão e recomendada para builds Android.
    runs-on: ubuntu-latest

    # Passos (Steps): A sequência de ações que compõem o trabalho.
    steps:
      # 1. Checkout do Código
      # Baixa o código do seu repositório para a máquina virtual.
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. Configurar o Java (JDK)
      # O Flutter para Android depende do Java Development Kit.
      # A versão 17 é uma escolha segura e moderna para builds Android atuais.
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      # 3. Configurar o Flutter SDK
      # Baixa e instala a versão especificada do Flutter na máquina virtual.
      # É uma boa prática fixar a versão para garantir builds consistentes.
      # Verifique a sua versão local com `flutter --version` e use-a aqui.
      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.38.6'
          channel: 'stable'
          cache: false

      # 3.1 Verificar a Instalação do Flutter
      - name: Flutter doctor -v
        run: flutter doctor -v

      # 4. Instalar Dependências do Projeto
      # Executa `flutter pub get` para baixar todos os pacotes listados no pubspec.yaml.
      - name: Install dependencies
        run: flutter pub get
      
      - name: List all CMakeLists.txt in .pub-cache (DEBUG)
        run: |
            find /home/runner/.pub-cache -name "CMakeLists.txt" -type f -print | sort
      
      # 4.1 Remove build-id from flutter_zxing para que os binários sejam idênticos ao F-Droid
      - name: Remove build-id from flutter_zxing (Reproducible Build)
        run: |
          CACHE_PATH="/home/runner/.pub-cache"
          echo "Aplicando patch em: $CACHE_PATH"

          # Encontra todos os CMakeLists.txt do flutter_zxing
          find "$CACHE_PATH" -name "CMakeLists.txt" -path "*/flutter_zxing-*/android/src/main/cpp/CMakeLists.txt" -print | while read file; do
            if ! grep -q "add_link_options.*--build-id=none" "$file"; then
              echo "Adicionando --build-id=none em $file"
              echo 'add_link_options("LINKER:--build-id=none")' >> "$file"
            fi
          done
          
          # Verifica se modificou algum arquivo
          if [ -z "$(find "$CACHE_PATH" -name "CMakeLists.txt" -path "*/flutter_zxing-*/android/src/main/cpp/CMakeLists.txt" -exec grep -l "add_link_options.*--build-id=none" {} \;)" ]; then
            echo "Nenhum arquivo do flutter_zxing modificado."
          else
            echo " Patch aplicado com sucesso."
          fi
    
      # 5. Limpar o Projeto (Boa Prática)
      # Executa `flutter clean` para garantir que não há artefactos de builds anteriores.
      - name: Clean project
        run: flutter clean

      # 6.1. Descodificar a Keystore e criar o key.properties
      - name: Decode Keystore and Create Properties
        run: |
          # Descodifica a keystore para a raiz do projeto (onde o Gradle espera)
          echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 --decode > upload-keystore.jks
          
          # Cria o ficheiro key.properties dentro da pasta android/
          echo "storePassword=${{ secrets.ANDROID_STORE_PASSWORD }}" > android/key.properties
          echo "keyPassword=${{ secrets.ANDROID_KEY_PASSWORD }}" >> android/key.properties
          echo "keyAlias=${{ secrets.ANDROID_KEY_ALIAS }}" >> android/key.properties
          echo "storeFile=../../upload-keystore.jks" >> android/key.properties
      
      - name: Debug print ANDROID_NDK_HOM
        run: echo $ANDROID_NDK_HOME

      # 6.2.1 Instalar a versão exigida pelo projeto
      - name: Install Android NDK 27.0.12077973
        run: |
          echo "y" | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --install "ndk;27.0.12077973"

      # 6.2.2 Configurar os caminhos para a versão 27
      - name: Configure NDK Path
        run: |
          NDK_PATH="$ANDROID_HOME/ndk/27.0.12077973"
          echo "ndk.dir=$NDK_PATH" > android/local.properties
          echo "ANDROID_NDK_HOME=$NDK_PATH" >> $GITHUB_ENV

      - name: Verify NDK setup
        run: $ANDROID_NDK_HOME/ndk-build --version

      # 6.2.3 Instalar outras dependências do SDK Android
      - name: Install Android SDK Build-Tools 36
        run: |
          echo "y" | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager "build-tools;36.0.0"
      
      - name: Aceitar licenças do SDK Android                                                                                                                       
        run: |
          SDKMANAGER=$ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager
          
          if [ ! -f "$SDKMANAGER" ]; then
            SDKMANAGER=$ANDROID_HOME/tools/bin/sdkmanager
          fi
          
          echo "Usando: $SDKMANAGER"
          yes | $SDKMANAGER --licenses || true
          $SDKMANAGER "build-tools;36.0.0-rc1" "platforms;android-36"

      # 6.2.4 Inspecionar o Ambiente de Build
      - name: Inspect Build Environment
        working-directory: android
        run: |
          echo "=== Java Version ==="
          java -version
          
          echo "=== Flutter Version ==="
          flutter --version
          
          echo "=== Android SDK Tools ==="
          ls $ANDROID_HOME/build-tools/
          
      # 6.2.5 Compilar o APK de Release
      - name: Build APK
        run: flutter build apk --release --no-tree-shake-icons
        # Removido o 'env: ANDROID_NDK_HOME' que usava o steps.setup-ndk (causava erro)
        # O Flutter já vai ler o ANDROID_NDK_HOME do GITHUB_ENV definido acima

      # 6.2.6 Obter o SHA256 do APK Gerado
      - name: Get APK SHA256
        run: |
          SHA_VALUE=$(sha256sum build/app/outputs/flutter-apk/app-release.apk | awk '{ print $1 }')
          echo "O SHA256 do seu APK é: $SHA_VALUE"

      # 7. Renomear o APK (Opcional, mas recomendado)
      # Renomeia o `app-release.apk` para um nome mais descritivo, incluindo a versão da tag.
      # `${{ github.ref_name }}` é uma variável do GitHub que contém o nome da tag (ex: "v1.0.0").
      - name: Rename APK
        run: mv build/app/outputs/flutter-apk/app-release.apk CajuScan-${{ github.ref_name }}.apk

      # 8. Ler notas para a Release
      # Esta etapa lê o conteúdo do ficheiro RELEASE_NOTES.md para usar como corpo da release.       
      - name: Read release body from file
        run: |
          # Gera um delimitador único para evitar conflitos com o conteúdo do MD
          DELIMITER=$(dd if=/dev/urandom bs=15 count=1 2>/dev/null | base64)
          echo "RELEASE_BODY<<$DELIMITER" >> $GITHUB_ENV
          cat RELEASE_NOTES.md >> $GITHUB_ENV
          echo "" >> $GITHUB_ENV
          echo "$DELIMITER" >> $GITHUB_ENV

      # 9. Fazer Upload do APK para a Release
      # Esta ação faz o upload do APK compilado e anexa-o à página da Release no GitHub.
      - name: Upload APK to Release
        uses: softprops/action-gh-release@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          # O nome do ficheiro que será anexado à release.
          files: CajuScan-${{ github.ref_name }}.apk
          # O nome / título da release.
          name: "CajuScan ${{ github.ref_name }}"
          # O nome da tag associada à release.
          tag_name: ${{ github.ref_name }}
          # O corpo da release, lido do ficheiro RELEASE_NOTES.md.
          body: ${{ env.RELEASE_BODY }}

      # 10. Limpeza Final (Segurança)
      - name: Clean up sensitive files
        if: ${{ always() }} # Garante que executa mesmo se o build falhar
        run: |
          # Remove a keystore da raiz (conforme criado no passo 6.1)
          rm -f upload-keystore.jks
          # Remove o ficheiro de propriedades da pasta android/
          rm -f android/key.properties
          # Remove ficheiros de ambiente, se existirem
          rm -f .env
          echo "Ficheiros sensíveis removidos com sucesso."
